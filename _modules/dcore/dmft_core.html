
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>dcore.dmft_core &#8212; DCore 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/triqs.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/dcore.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
    <script src="../../_static/cufon-yui.js" type="text/javascript"></script>
    <script src="../../_static/spaceman.cufonfonts.js" type="text/javascript"></script>
    <script type="text/javascript">
      Cufon.replace('.triqs', { fontFamily: 'spaceman', hover: true }); 
    </script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>

  </head>
  <body>
<div class="pageheader">
  <ul>
    
    <li><a href="../../install.html">Install</a></li>
    
    <li><a href="../../documentation.html">Documentation</a></li>
    
    <li><a href="../../issues.html">Issues</a></li>
    
    <li><a href="../../about.html">About DCore</a></li>
    
  </ul>
  <div>
    <h1 style="padding:0; margin: 10px 0 0 0;"><a class="triqs" href="../../index.html">DCore</a></h1>
    <span style="font-size: 14px; margin: 0px; padding: 0px;">integrated DMFT software for CORrelated Electrons</span>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for dcore.dmft_core</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># DCore -- Integrated DMFT software for correlated electrons</span>
<span class="c1"># Copyright (C) 2017 The University of Tokyo</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">__builtin__</span>
<span class="kn">from</span> <span class="nn">pytriqs.operators.util</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pytriqs.applications.dft.sumk_dft</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pytriqs.operators</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">program_options</span> <span class="k">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">__gettype</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__builtin__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_solver_params</span><span class="p">(</span><span class="n">ini_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a dict and create parameters for an impurity solver.</span>
<span class="sd">    In dict, keyname should be parameter_name{python_type_name} (e.g. max_time{int}).</span>

<span class="sd">    :param ini_dict: a dict object containing keys and values read from *.ini</span>
<span class="sd">    :return: a dict object containing parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solver_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ini_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(.*)\{(.*)\}$&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">param_name</span><span class="p">,</span> <span class="n">param_type_str</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">param_type</span> <span class="o">=</span> <span class="n">__gettype</span><span class="p">(</span><span class="n">param_type_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown type or unrecognized format : &quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">solver_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">solver_params</span>


<div class="viewcode-block" id="DMFTCoreSolver"><a class="viewcode-back" href="../../reference/DMFTCoreSolver.html#dcore.dmft_core.DMFTCoreSolver">[docs]</a><span class="k">class</span> <span class="nc">DMFTCoreSolver</span><span class="p">:</span>
<div class="viewcode-block" id="DMFTCoreSolver.__init__"><a class="viewcode-back" href="../../reference/DMFTCoreSolver.html#dcore.dmft_core.DMFTCoreSolver.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seedname</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize solver at each inequivalent correlation shell</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seedname : string</span>
<span class="sd">            seedname</span>
<span class="sd">        params : dict</span>
<span class="sd">            Input parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># Construct a SumKDFT object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SK</span> <span class="o">=</span> <span class="n">SumkDFT</span><span class="p">(</span><span class="n">hdf_file</span><span class="o">=</span><span class="n">seedname</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="n">use_dft_blocks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">h_field</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">u_file</span> <span class="o">=</span> <span class="n">HDFArchive</span><span class="p">(</span><span class="n">seedname</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Umat</span> <span class="o">=</span> <span class="n">u_file</span><span class="p">[</span><span class="s2">&quot;DCore&quot;</span><span class="p">][</span><span class="s2">&quot;Umat&quot;</span><span class="p">]</span>

        <span class="c1"># Construct an impurity solver</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
        <span class="n">n_iw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_iw&#39;</span><span class="p">])</span>  <span class="c1"># Number of Matsubara frequencies</span>
        <span class="n">n_tau</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_tau&#39;</span><span class="p">])</span>  <span class="c1"># Number of tau points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;impurity_solver&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span> <span class="o">=</span> <span class="n">create_solver_params</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;impurity_solver&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;verbosity&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">[</span><span class="s1">&#39;verbosity&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">n_inequiv_shells</span><span class="p">):</span>

            <span class="c1"># Use GF structure determined by DFT blocks</span>
            <span class="n">gf_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">gf_struct_solver</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;TRIQS/cthyb&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">pytriqs.applications.impurity_solvers.cthyb</span> <span class="k">import</span> <span class="n">Solver</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">[</span><span class="s1">&#39;measure_g_l&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">[</span><span class="s1">&#39;measure_g_tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Solver</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gf_struct</span><span class="o">=</span><span class="n">gf_struct</span><span class="p">,</span>
                                         <span class="n">n_iw</span><span class="o">=</span><span class="n">n_iw</span><span class="p">,</span> <span class="n">n_tau</span><span class="o">=</span><span class="n">n_tau</span><span class="p">,</span> <span class="n">n_l</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Solver</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gf_struct</span><span class="o">=</span><span class="n">gf_struct</span><span class="p">,</span> <span class="n">n_iw</span><span class="o">=</span><span class="n">n_iw</span><span class="p">,</span> <span class="n">n_tau</span><span class="o">=</span><span class="n">n_tau</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;TRIQS/hubbard-I&quot;</span><span class="p">:</span>
                <span class="n">n_orb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="kn">from</span> <span class="nn">hubbard_solver_matrix</span> <span class="k">import</span> <span class="n">Solver</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Solver</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">norb</span><span class="o">=</span><span class="n">n_orb</span><span class="p">,</span> <span class="n">n_msb</span><span class="o">=</span><span class="n">n_iw</span><span class="p">,</span> <span class="n">use_spin_orbit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;ALPS/cthyb&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">pytriqs.applications.impurity_solvers.alps_cthyb</span> <span class="k">import</span> <span class="n">Solver</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Solver</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gf_struct</span><span class="o">=</span><span class="n">gf_struct</span><span class="p">,</span> <span class="n">assume_real</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">n_iw</span><span class="o">=</span><span class="n">n_iw</span><span class="p">,</span> <span class="n">n_tau</span><span class="o">=</span><span class="n">n_tau</span><span class="p">,</span> <span class="n">n_l</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Solver</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gf_struct</span><span class="o">=</span><span class="n">gf_struct</span><span class="p">,</span> <span class="n">assume_real</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_iw</span><span class="o">=</span><span class="n">n_iw</span><span class="p">,</span> <span class="n">n_tau</span><span class="o">=</span><span class="n">n_tau</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown solver &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span><span class="p">)</span></div>

    <span class="c1"># Make read-only getter</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_step</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">output_group</span><span class="o">=</span><span class="s1">&#39;dmft_output&#39;</span><span class="p">):</span>
        <span class="n">with_dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;with_dc&#39;</span><span class="p">]</span>

        <span class="n">fix_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;fix_mu&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">chemical_potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>

        <span class="n">sigma_mix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;sigma_mix&#39;</span><span class="p">]</span>  <span class="c1"># Mixing factor of Sigma after solution of the AIM</span>

        <span class="n">prec_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;prec_mu&#39;</span><span class="p">]</span>

        <span class="n">previous_runs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nsh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">n_inequiv_shells</span>

        <span class="c1"># Just for convenience</span>
        <span class="n">sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>

        <span class="c1"># Set up a HDF file for output</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">HDFArchive</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">output_group</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;restart&#39;</span><span class="p">]:</span>
                            <span class="n">ar</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">output_group</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;iterations&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ar</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to restart the previous simulation!&quot;</span><span class="p">)</span>
    
                            <span class="n">previous_runs</span> <span class="o">=</span> <span class="n">ar</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">ar</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No previous runs to be loaded from &quot;</span> <span class="o">+</span> <span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading Sigma_iw... &quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                                <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">ar</span><span class="p">[</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">ar</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">])][</span><span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="n">output_group</span><span class="p">]</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">output_group</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">output_group</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
                    <span class="c1">#</span>
                    <span class="c1"># Sub group for something</span>
                    <span class="c1">#</span>
                    <span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">,</span> <span class="s1">&#39;G_l&#39;</span><span class="p">,</span> <span class="s1">&#39;chemical_potential&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">gname</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">output_group</span><span class="p">]):</span>
                            <span class="n">f</span><span class="p">[</span><span class="n">output_group</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error occurred in IO of a HDF file: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">previous_runs</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">previous_runs</span><span class="p">)</span>
        <span class="n">previous_present</span> <span class="o">=</span> <span class="n">previous_runs</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">previous_present</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">chemical_potential</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">dc_energ</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;chemical_potential&#39;</span><span class="p">,</span> <span class="s1">&#39;dc_imp&#39;</span><span class="p">,</span> <span class="s1">&#39;dc_energ&#39;</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Broadcasting Sigma_iw, chemical_potential, dc_imp, dc_energ... &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">)</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">chemical_potential</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">chemical_potential</span><span class="p">)</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">dc_imp</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">)</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">dc_energ</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">dc_energ</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iteration_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">previous_runs</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">previous_runs</span><span class="o">+</span><span class="n">max_step</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#####################################################################&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;########################  Iteration = </span><span class="si">%5d</span><span class="s2">  ########################&quot;</span> <span class="o">%</span> <span class="n">iteration_number</span><span class="p">,</span>
                       <span class="s2">&quot;#####################################################################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">@@@@@@@@@@@@@@@@@@@@@@@@  Chemical potential and G0_imp  @@@@@@@@@@@@@@@@@@@@@@@@</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">sk</span><span class="o">.</span><span class="n">set_Sigma</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">)])</span>   <span class="c1"># set Sigma into the SumK class</span>
            <span class="k">if</span> <span class="n">fix_mu</span><span class="p">:</span>
                <span class="n">chemical_potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
                <span class="n">chemical_potential</span> <span class="o">=</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">chemical_potential</span><span class="p">)</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">set_mu</span><span class="p">(</span><span class="n">chemical_potential</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sk</span><span class="o">.</span><span class="n">calc_mu</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="n">prec_mu</span><span class="p">)</span>  <span class="c1"># find the chemical potential for given density</span>
            <span class="c1">#</span>
            <span class="c1"># Compute and display density matrix</span>
            <span class="c1">#</span>
            <span class="n">dm_tot</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">density_matrix</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Density Matrix&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Shell &quot;</span><span class="p">,</span> <span class="n">icrsh</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sk</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="n">sk</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s1">&#39;SO&#39;</span><span class="p">]]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Spin &quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dm_tot</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="n">sp</span><span class="p">][</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Extract Local Green&#39;s function</span>
            <span class="c1">#</span>
            <span class="n">g_iw_all</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">extract_G_loc</span><span class="p">(</span><span class="n">with_dc</span><span class="o">=</span><span class="n">with_dc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span> <span class="o">&lt;&lt;</span> <span class="n">g_iw_all</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span>                         <span class="c1"># calc the local Green function</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Total charge of Gloc_{shell </span><span class="si">%d</span><span class="s2">} : </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ish</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="o">.</span><span class="n">total_density</span><span class="p">()))</span>
            <span class="c1">#</span>
            <span class="c1"># Init the DC term and the real part of Sigma, if no previous runs found:</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">iteration_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">previous_present</span> <span class="ow">and</span> <span class="n">with_dc</span><span class="p">:</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">@@@@@@@@@@@@@@@@@@@@@@@@  Double-Counting Correction  @@@@@@@@@@@@@@@@@@@@@@@@</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                    <span class="n">dm</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="o">.</span><span class="n">density</span><span class="p">()</span>
                    <span class="c1">#</span>
                    <span class="c1"># Initial guess of Sigma (Hartree-Fock)</span>
                    <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calc_dc_matrix</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">orb</span><span class="o">=</span><span class="n">ish</span><span class="p">,</span> <span class="n">u_mat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Umat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span><span class="p">:</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">sk</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;ud&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">sk</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;up&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># Calculate new G0_iw as an input of solver:</span>
            <span class="c1">#</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G0_iw</span> <span class="o">&lt;&lt;</span> <span class="n">dyson</span><span class="p">(</span><span class="n">Sigma_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">,</span> <span class="n">G_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="p">)</span>

            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wall Time : </span><span class="si">%.1f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">@@@@@@@@@@@@@@@@@@@@@@@@  Solve the impurity problem  @@@@@@@@@@@@@@@@@@@@@@@@</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_name</span> <span class="o">==</span> <span class="s2">&quot;TRIQS/hubbard-I&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;verbosity&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">[</span><span class="s2">&quot;verbosity&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># calculate non-interacting atomic level positions:</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                    <span class="n">norb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">umat2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
                    <span class="n">umat2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Umat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="mi">0</span><span class="p">:</span><span class="n">norb</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">norb</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">norb</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">norb</span><span class="p">]</span>

                    <span class="n">eal</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">eff_atomic_levels</span><span class="p">()</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">set_atomic_levels</span><span class="p">(</span><span class="n">eal</span><span class="o">=</span><span class="n">eal</span><span class="p">[</span><span class="n">ish</span><span class="p">])</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">u_mat</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">umat2</span><span class="p">),</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>

                    <span class="n">h0_loc</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G0_iw</span><span class="p">:</span>
                        <span class="n">h0_loc</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">tail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">eigvec</span><span class="p">,</span> <span class="n">umat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diag_eal</span><span class="p">(</span><span class="n">ish</span><span class="o">=</span><span class="n">ish</span><span class="p">,</span> <span class="n">eal</span><span class="o">=</span><span class="n">h0_loc</span><span class="p">)</span>
                    <span class="n">h_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_int_general</span><span class="p">(</span><span class="n">ish</span><span class="o">=</span><span class="n">ish</span><span class="p">,</span> <span class="n">u_mat</span><span class="o">=</span><span class="n">umat2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;density_density&quot;</span><span class="p">]:</span>
                        <span class="n">h_int</span> <span class="o">=</span> <span class="n">diagonal_part</span><span class="p">(</span><span class="n">h_int</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G0_iw</span><span class="p">:</span>
                        <span class="n">gf</span><span class="o">.</span><span class="n">from_L_G_R</span><span class="p">(</span><span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="n">gf</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">[</span><span class="s1">&#39;random_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">34788</span> <span class="o">+</span> <span class="mi">928374</span> <span class="o">*</span> <span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ish</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">h_int</span><span class="o">=</span><span class="n">h_int</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_params</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;perform_tail_fit&quot;</span><span class="p">]:</span>
                        <span class="n">tail_fit</span><span class="p">(</span><span class="n">Sigma_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">,</span> <span class="n">G0_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G0_iw</span><span class="p">,</span> <span class="n">G_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="p">,</span>
                                 <span class="n">fit_max_moment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;fit_max_moment&quot;</span><span class="p">],</span>
                                 <span class="n">fit_min_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;fit_min_w&quot;</span><span class="p">],</span>
                                 <span class="n">fit_max_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">][</span><span class="s2">&quot;fit_max_w&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_l</span><span class="p">:</span>
                            <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">LegendreToMatsubara</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">dyson</span><span class="p">(</span><span class="n">G0_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G0_iw</span><span class="p">,</span> <span class="n">G_iw</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">:</span>
                        <span class="n">gf</span><span class="o">.</span><span class="n">from_L_G_R</span><span class="p">(</span><span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">bname</span><span class="p">,</span> <span class="n">gf</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_l</span><span class="p">:</span>
                        <span class="n">gf</span><span class="o">.</span><span class="n">from_L_G_R</span><span class="p">(</span><span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">],</span> <span class="n">gf</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">[</span><span class="n">bname</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>

            <span class="c1"># Solved. Now do post-processing:</span>
            <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total charge of impurity problem : </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_iw</span><span class="o">.</span><span class="n">total_density</span><span class="p">())</span>

            <span class="c1"># Now mix Sigma and G with factor sigma_mix, if wanted:</span>
            <span class="k">if</span> <span class="n">iteration_number</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">previous_present</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
                    <span class="n">ar</span> <span class="o">=</span> <span class="n">HDFArchive</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                        <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">sigma_mix</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> \
                                    <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sigma_mix</span><span class="p">)</span> <span class="o">*</span> <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration_number</span><span class="o">-</span><span class="mi">1</span><span class="p">)][</span><span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)]</span>

                    <span class="k">del</span> <span class="n">ar</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span> <span class="o">&lt;&lt;</span> <span class="n">mpi</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span><span class="p">)</span>

            <span class="c1"># Write Sigma and G to the hdf5 archive:</span>
            <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
                <span class="n">ar</span> <span class="o">=</span> <span class="n">HDFArchive</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
                <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration_number</span>
                <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;chemical_potential&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration_number</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">chemical_potential</span>
                <span class="k">for</span> <span class="n">ish</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsh</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;n_l&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;G_l&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">G_l</span>
                    <span class="c1">#</span>
                    <span class="c1"># Save the history of Sigma</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration_number</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">]):</span>
                        <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration_number</span><span class="p">))</span>
                    <span class="n">ar</span><span class="p">[</span><span class="n">output_group</span><span class="p">][</span><span class="s1">&#39;Sigma_iw&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration_number</span><span class="p">)][</span><span class="nb">str</span><span class="p">(</span><span class="n">ish</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ish</span><span class="p">]</span><span class="o">.</span><span class="n">Sigma_iw</span>
                <span class="k">del</span> <span class="n">ar</span>

            <span class="n">mpi</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wall Time : </span><span class="si">%.1f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

            <span class="c1"># Save stuff into the user_data group of hdf5 archive in case of rerun:</span>
            <span class="n">sk</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="s1">&#39;chemical_potential&#39;</span><span class="p">,</span> <span class="s1">&#39;dc_imp&#39;</span><span class="p">,</span> <span class="s1">&#39;dc_energ&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="DMFTCoreSolver.calc_dc_matrix"><a class="viewcode-back" href="../../reference/DMFTCoreSolver.html#dcore.dmft_core.DMFTCoreSolver.calc_dc_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">calc_dc_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dens_mat</span><span class="p">,</span> <span class="n">u_mat</span><span class="p">,</span> <span class="n">orb</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute double counting term with U-matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dens_mat : gf_struct_solver like</span>
<span class="sd">            Density matrix for the specified correlated shell.</span>
<span class="sd">        u_mat : float numpy array [:, :, :, :]</span>
<span class="sd">            4-index interaction matrix</span>
<span class="sd">        orb : int, optional</span>
<span class="sd">            Index of an inequivalent shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">orb</span><span class="p">]][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span>
        <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">orb</span><span class="p">]][</span><span class="s1">&#39;SO&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">orb</span><span class="p">]][</span><span class="s1">&#39;SO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">dim_tot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">dim_tot</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    DC for inequivalent shell </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      2-index U:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      2-index J:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      Local Density Matrix:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        Spin </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_tot</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_tot</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dens_mat</span><span class="p">[</span><span class="n">sp1</span><span class="p">][</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">icrsh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">n_corr_shells</span><span class="p">):</span>

            <span class="c1"># ish is the index of the inequivalent shell corresponding to icrsh</span>
            <span class="n">ish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_to_inequiv</span><span class="p">[</span><span class="n">icrsh</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ish</span> <span class="o">!=</span> <span class="n">orb</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ignore this orbital</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s1">&#39;SO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="n">sp1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim_tot</span><span class="p">,</span> <span class="n">dim_tot</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                            <span class="c1">#</span>
                            <span class="c1"># Hartree</span>
                            <span class="c1">#</span>
                            <span class="k">for</span> <span class="n">sp2</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="n">sp1</span><span class="p">][</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span> <span class="o">+=</span> \
                                    <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">]</span> <span class="o">*</span> <span class="n">dens_mat</span><span class="p">[</span><span class="n">sp2</span><span class="p">][:,</span> <span class="p">:])</span>
                            <span class="c1">#</span>
                            <span class="c1"># Exchange</span>
                            <span class="c1">#</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="n">sp1</span><span class="p">][</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span> <span class="o">+=</span> \
                                <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dens_mat</span><span class="p">[</span><span class="n">sp1</span><span class="p">][:,</span> <span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s2">&quot;ud&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim_tot</span><span class="p">,</span> <span class="n">dim_tot</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                                <span class="c1">#</span>
                                <span class="c1"># Hartree</span>
                                <span class="c1">#</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s2">&quot;ud&quot;</span><span class="p">][</span><span class="n">i1</span><span class="o">+</span><span class="n">s1</span><span class="o">*</span><span class="n">dim</span><span class="p">,</span> <span class="n">i2</span><span class="o">+</span><span class="n">s1</span><span class="o">*</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                                    <span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">]</span> <span class="o">*</span> <span class="n">dens_mat</span><span class="p">[</span><span class="s2">&quot;ud&quot;</span><span class="p">][</span><span class="n">s2</span><span class="o">*</span><span class="n">dim</span><span class="p">:</span><span class="n">s2</span><span class="o">*</span><span class="n">dim</span><span class="o">+</span><span class="n">dim</span><span class="p">,</span> <span class="n">s2</span><span class="o">*</span><span class="n">dim</span><span class="p">:</span><span class="n">s2</span><span class="o">*</span><span class="n">dim</span><span class="o">+</span><span class="n">dim</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="c1">#</span>
                                <span class="c1"># Exchange</span>
                                <span class="c1">#</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="n">icrsh</span><span class="p">][</span><span class="s2">&quot;ud&quot;</span><span class="p">][</span><span class="n">i1</span> <span class="o">+</span> <span class="n">s1</span> <span class="o">*</span> <span class="n">dim</span><span class="p">,</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">s2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                                    <span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span>
                                    <span class="o">*</span> <span class="n">dens_mat</span><span class="p">[</span><span class="s2">&quot;ud&quot;</span><span class="p">][</span><span class="n">s2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">:</span><span class="n">s2</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">dim</span><span class="p">,</span> <span class="n">s1</span> <span class="o">*</span> <span class="n">dim</span><span class="p">:</span><span class="n">s1</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="n">dim</span><span class="p">]</span>
                                <span class="p">)</span>

        <span class="k">if</span> <span class="n">mpi</span><span class="o">.</span><span class="n">is_master_node</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      DC Self Energy:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orb</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">sp1</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        Spin </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_tot</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_tot</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">dc_imp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">orb</span><span class="p">]][</span><span class="n">sp1</span><span class="p">][</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">h_int_general</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ish</span><span class="p">,</span> <span class="n">u_mat</span><span class="p">):</span>

        <span class="n">n_orb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span><span class="p">:</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_orb</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
                <span class="n">index_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ud&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_orb</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
                <span class="n">index_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">index_name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">n_orb</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">n_orb</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">ham</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_orb</span><span class="p">):</span>
                        <span class="n">ham</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">u_mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">]</span> \
                               <span class="o">*</span> <span class="n">c_dag</span><span class="p">(</span><span class="o">*</span><span class="n">index_name</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span> <span class="o">*</span> <span class="n">c_dag</span><span class="p">(</span><span class="o">*</span><span class="n">index_name</span><span class="p">[</span><span class="n">i2</span><span class="p">])</span> \
                               <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="n">index_name</span><span class="p">[</span><span class="n">i4</span><span class="p">])</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="n">index_name</span><span class="p">[</span><span class="n">i3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ham</span>

    <span class="k">def</span> <span class="nf">diag_eal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ish</span><span class="p">,</span> <span class="n">eal</span><span class="p">):</span>

        <span class="n">eigvec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">eal</span><span class="p">)</span>
        <span class="n">spn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">spin_block_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;SO&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spn</span><span class="p">:</span>
            <span class="n">eigval</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">[</span><span class="n">sp</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">eal</span><span class="p">[</span><span class="n">sp</span><span class="p">])</span>
            <span class="c1"># eigvec[sp] = numpy.identity(len(eigval), numpy.complex_)  # debug</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">SO</span><span class="p">:</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">eigvec</span><span class="p">[</span><span class="s1">&#39;ud&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_orb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">corr_shells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_orb</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_orb</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">complex_</span><span class="p">)</span>
            <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_orb</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n_orb</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigvec</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]</span>
            <span class="n">rot</span><span class="p">[</span><span class="n">n_orb</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n_orb</span><span class="p">,</span> <span class="n">n_orb</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n_orb</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigvec</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]</span>

        <span class="n">u_mat2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkl,im,jn,ko,lp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Umat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SK</span><span class="o">.</span><span class="n">inequiv_to_corr</span><span class="p">[</span><span class="n">ish</span><span class="p">]],</span>
                              <span class="n">numpy</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">rot</span><span class="p">),</span> <span class="n">rot</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eigvec</span><span class="p">,</span> <span class="n">u_mat2</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../index.html">Home</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The University of Tokyo.
    </div>
  </body>
</html>